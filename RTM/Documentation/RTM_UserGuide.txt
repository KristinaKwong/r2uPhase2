# TransLink Regional Transportation Model - Phase 3 Userguide

# Introduction


# Model Format

The model is now delivered as a collection of plain text files with an initial script to build the emmebank
in which the model is run. An emme project file (.emp) is provided to reference all required folders and to link
in an empty, minimally sized databank in the Template/ folder. This is only provided to allow emme modeller tools to
run before an RTM phase 3 databank has been initialized.

**RTM Phase 3 Folder Structure**

~~~
RTM.emp
BaseNetworks/
BaseNetworks/Inputs/
Documentation/
Logbook/
Media/
Scripts/
Template/
Views/
Worksheets/
~~~

## RTM.emp
This file contains all of the project information for the EMME model and allows the software
to reference all of the distributed folders consistantly.

## BaseNetworks/
This folder contains all of the files required to build a databank and contains:
* Network batchin files for horizon years 2011, 2015, 2030 and 2045
* External demand matrices
* Definitions of ensembles, modes, transit vehicles
* Networks: Auto, Transit, Turns for 4 horizon years and 3 time periods
* Starter Skims
* External demand bike scores
* Calibration factors K-factors
* Ensembles

## BaseNetworks/Inputs/
This folder contains the default model assumptions for each horizon year, a copy
of this folder is placed with each databank initialized by the InitEmmebank tool.

* Demographics from metro Vancouver
* Dummies for town centres / other
* Geographics
* Park n ride
* Batch input files used in truck model

## Documentation/
A copy of the model userguide and other technical documentation.

## Logbook/
This folder holds the logbook information generated by EMME Modeller tools.

## Media/
Shapefiles used as background boundaries in EMME worksheets are provided here, layers for the following are provided:
* Zone Boundary for 1700 Zone System
* National Road Network Centerlines extracted for the modelled region
* Municipal Boundaries
* Zone Boundaries and Municipal Boundaries from the earlier 641 Zone System

## Scripts/

## Template/
A minimally dimensioned EMME databank is distributed to allow Modeller tools to run before an RTM databank has been initailized.
No information is held in this template databank, it is provided only to allow Modeller to initialize an RTM databank from the provided text files.

## Views/
Definitions for some standard views are provided in the EMME environment. Standard views for the GVRD, FVRD, each GY aggregation and each municiaplity are provided.
## Worksheets/

# Receiving/Relocating an RTM Model

All file references have been updated to be relative to the provided emme project file (RTM.emp). The only exception to this are
references to modeller python files in the EMME toolboxes. A batch file has been provided in Scripts/relocate_tools.bat to
link the toolboxes to the appropriate file if the project is moved.

This batch file must be run whenever the model is initially unpacked from a zip file, or whenever the project is moved to a different
folder on the hard disk. If this is not done, Modeller will not be able to run any of the RTM scripting.

If the following error is encountered when running this script:

~~~
Traceback (most recent call last):
  File "toolbox_modify.py", line 155, in <module>
    set_tools_to_current_root(toolbox_path, root_dir_name)
  File "toolbox_modify.py", line 129, in set_tools_to_current_root
    with ToolboxWrap(toolbox_path) as toolbox:
  File "toolbox_modify.py", line 60, in __init__
    self.documents = self.connection.execute('select * from documents').fetchall()
sqlite3.DatabaseError: file is encrypted or is not a database
~~~

It is likely that a Modeller instance is running and has locked the toolbox file. Close all Modeller instances and run the
script again.

## CSV Text Files
The csv input files for zone-based data has been introduced to provide a more convenient data format than the EMME batch-transaction files.
Zone based data intended for an mo or md matrix can now be entered using a format more usable with Excel and other external tools in a column-based format.
The first four rows are headers providing the following information, examples given are from the demograpics input file:

* The mo or md matrix to store the data in  (mo10)
* The name for the EMME matrix (TotPop)
* The description for the EMME matrix (POP_Total)
* The column name in the SQL database where a copy of the data is kept (POP_Total)

The first column of data is the zone number the data values are intended for.

### Demographics Input File
The demographics input file contains the following data

|Matrix ID|EMME Name|EMME Description|SQL NAME|Notes     |
|:-------:|:--------|:---------------|:-------|:---------|
|mo10     |TotPop     |POP_Total              |POP_Total                   |Total Population                               |
|mo11     |Pop0t4     |POP_0to4               |POP_0to4                    |Population Ages 0 to 4                         |
|mo12     |Pop5t12    |POP_5to12              |POP_5to12                   |Population Ages 5 to 12                        |
|mo13     |Pop13t17   |POP_13to17             |POP_13to17                  |Population Ages 13 to 17                       |
|mo14     |Pop18t24   |POP_18to24             |POP_18to24                  |Population Ages 18 to 24                       |
|mo15     |Pop25t34   |POP_25to34             |POP_25to34                  |Population Ages 25 to 34                       |
|mo16     |Pop35t54   |POP_35to54             |POP_35to54                  |Population Ages 35 to 54                       |
|mo17     |Pop55t64   |POP_55to64             |POP_55to64                  |Population Ages 55 to 64                       |
|mo18     |Pop65Up    |POP_65plus             |POP_65plus                  |Population Ages 65 plus                        |
|mo20     |TotEmp     |EMP_Total              |EMP_Total                   |Total Employment                               |
|mo21     |EmpConMfg  |Construct_Mfg          |EMP_Construct_Mfg           |Employment: Construction, Manufacturing        |
|mo22     |EmpFire    |FIRE                   |EMP_FIRE                    |                                               |
|mo23     |EmpTcuWh   |TCU_Wholesale          |EMP_TCU_Wholesale           |                                               |
|mo24     |EmpRet     |Retail                 |EMP_Retail                  |                                               |
|mo25     |EmpBoS     |Business_OtherServices |EMP_Business_OtherServices  |                                               |
|mo26     |EmpAcFoInCu|AccomFood_InfoCult     |EMP_AccomFood_InfoCult      |                                               |
|mo27     |EmpHeEdPuAd|Health_Educat_PubAdmin |EMP_Health_Educat_PubAdmin  |                                               |
|mo30     |EnrolElem  |Elementary_Enrolment   |Elementary_Enrolment        |Elementary School Enrollment                   |
|mo31     |EnrolSec   |Secondary_Enrolment    |Secondary_Enrolment         |Secondary School Enrollment                    |
|mo32     |EnrolPsFte |PostSecFTE             |PostSecFTE                  |Post Secondary Full Time Equivalent Enrollment |
|mo40     |TotHh      |HHOLDS_Total           |HH_Total                    |Total Households                               |
|mo41     |Hh1p       |HHOLDS_1Person         |HH_1Person                  |1 Person Households                            |
|mo42     |Hh2p       |HHOLDS_2Person         |HH_2Person                  |2 Person Households                            |
|mo43     |Hh3p       |HHOLDS_3Person         |HH_3Person                  |3 Person Households                            |
|mo44     |Hh4pUp     |HHOLDS_4plusPerson     |HH_4plusPerson              |4-plus Person Households                       |


### Geographics Input File
The demographics input file contains the following data

|Matrix ID|EMME Name|EMME Description|SQL NAME|Notes     |
|:-------:|:--------|:----------------|:-------|:-------------|
|mo50     |areahc   |taz_a_area_hec   |Hectares             |Zone Area in Hectares                      |
|mo60     |prk2hr   |parkingcost2hr   |parking_two_hr_rate  |Two Hour Parking Rate                      |
|mo61     |prk8hr   |parkingcost8hr   |parking_eight_hr_rate|Eight Hours Parking Rate                   |
|mo69     |railStn  |railstationinzone|rail_stn_dummy       |Zone contains a rail station (0/1)         |
|mo70     |cs250    |car_share_250m   |car_share_250m       |Zone has car share access within 250m (0/1)|
|mo71     |cs500    |car_share_500m   |car_share_500m       |Zone has car share access within 500m (0/1)|
|mo80     |bikesc   |bikescore        |bike_score_taz       |Bike Score (0-5)                           |

# Databank Initialization

Once the text files have been unpacked and the scripts relocated, open the emme modeller toolbox and run the InitEmmebank tool,
this will allow an RTM Phase 3 Databank to be initialized and linked into the current project. The tool requires a folder name which
will be created, and the name of the databank to be shown in the project.

The new

![The Initialize Emmebank Tool](./InitEmmebank_screen.png)

# Running the RTM Phase 3 Model

![The RTM Phase 3 Model Run Tool](./FullModelRun_screen.png)

# Network Coding

## Modes

Modes are represented in the same manner as the Phase 2 model, with the addition of a new primary auto mode (v).
The primary auto mode and must be coded on any link that is expected to be used by any of the other auto modes.

|Mode|Description|
|:--:|:----------|
|v   |Vehicles (Primary Auto Mode)         |
|c   |High Occupancy Vehicles (HOV)        |
|d   |Single Occupancy Vehicles (SOV)      |
|x   |Light Trucks                         |
|t   |Heavy Trucks                         |
|n   |Discourage Heavy Vehicle Traffic     |
|b   |Bus                                  |
|p   |Pedestrian                           |
|a   |Auxillary Transit Access             |
|l   |SkyTrain                             |
|r   |Commuter Rail (West Coast Express)   |
|s   |SeaBus                               |
|h   |Gondola                              |

## Link Types

Links have been classified by their basic role for data summary purposes.
There is currently no functional differences represented by the link type, but there may be in the future.

|Type|Description|
|:--:|:----------|
|1   |Centroid Connector            |
|2   |Pedestrian Links              |
|3   |Bowen Island Ferry            |
|100 |SkyTrain                      |
|101 |SeaBus                        |
|102 |West Coast Express            |
|103 |Gondola                       |
|200 |Bus Only                      |
|201 |HOV Lane                      |
|202 |Commercial Vehicle Access Only|
|300 |Freeway                       |
|301 |Highway                       |
|302 |Arterial                      |
|303 |Collector                     |
|304 |Local                         |
|305 |Ramp                          |
|306 |Highway Directional Ramp      |
|307 |Highway Loop Ramp             |
|310 |Other Roads                   |

## Extra Attributes

During a model run, a single master scenario is copied into 3 time of day specific scenarios for assignment.
The network parameters are coded in extra attributes in the master scenario and copied to the appropriate place
when the copies are made. A correspondence of from the master scenario to the time of day attributes is presented below.

|Master Scenario Attribute|     Time of Day Attributes    |
|:-----------------------:|:-------------------------------:|
|lanes                    |lanesam, lanesmd, lanespm |
|vdf                      |vdfam, vdfmd, vdfpm       |
|tpf                      |tpfam, tpfmd, tpfpm       |
|tolls                    |tollam, tollmd, tollpm    |
|hdwy                     |hdwyam, hdwymd, hdwypm    |

## Network Modification Issues

### Issue 1 - Adding new Links
When adding new links that connect to a node defined as an intersection, be sure to review the new turns created as EMME will only auto-populate the tpf attribute, and not the time of day extra attributes, this could cause illogical turns to be allowed as the default value of the extra attribute is 0, which would disable all turns from or to the new link.

### Issue 2 - Adding new Intersections
Similar to Issue 1, when newly defining an intersection, ensure the extra turn attributes are coded to match the automatically set tpf values, otherwise all turns will be disabled at that node (tpf=0)

### Issue 3 - Adding new Transit services
When adding new itineraries, make sure the extra headway attributes are populated as expected, or the effective headway of 0 will cause these services to be removed when constructing the time of day networks.

## Export Network Tool

Network coding should be done in the master scenarios only, as the time of day specific networks are overwritten
during each model run. The export network tool is responsible for exporting all required information from a scenario
for later import into the model run process. The dropdown area allows multiple scenarios to be exported at the same

![The Network Export Tool](./ExportNetwork_screen.png)

## Import Network Tool

Additional network scenarios can be imported to the emmebank using the Import Scenarios tool. This tool assumes all required files
are in the BaseNetworks/ folder. The name of the scenario to be import is a user input.

![The Network Import Tool](./ImportNetwork_screen.png)


# Scripts Folder

The Scripts folder contains the main toolboxes and python codes used for running the model. Figure <Screennshot of Scripts folder> shows the files
inside the folder.

## Util folder

The Util folder contains the Util toolbox and associated python script. The Util toolbox contains helper functions that
get used repeatedly within a model run. These helper functions are usually called from other Python Scripts. Examples include
helper functions and how to invoke them include the following:

 - Matrix Calculator : util.compute_matrix(<Arguments>)

 - Extra Attribute Calculator: util.emme_link_calc(<Arguments>)

 - Importing Matrix Data in Numpy Array format : util.get_matrix_numpy(<Arguments>)

These helper functions reduce the likelihood of making coding mistakes and make the overall code less repetitive and easier
to read.

## Phase3Scripts Folder

This folder contains the model's main python tool box and associated scripts. Figure <Phase3Scripts Screnshot> is a screenshot of the Phase3Scripts folder.
The following is a brief description of each script in the order of model run. Each of the scripts in this folder has an object reference to the
Util toolbox as shown in the screenshot (Figure <Screenshot of Util method invoke>) below from the trip productions python script - 06_TripProductions.py.

### InitEmmebank.py
Creates a new databank which contains the building blocks of the model run:

1. Databank Size
2. Auto and Transit Networks for years 2011, 2015, 2030 and 2045
3. Ensembles
4. Functions
   + Volume-delay (vdf)
   + Turn penalty (tpf)
   + Transit time (ttf)

### 00_RunModel.py
This the main model run wrapper and launches the subsequent model scripts. Figure <Screenshot of Run Page> is a screenshot of the run page with required user inputs:

1. Model horizon year:
    + 2011
    + 2015
    + 2030
    + 2045
2. Base Year Network Scenario:
    + Scen 1000 - 2011 Base Network
    + Scen 2000 - 2015 Base Network
    + Scen 3000 - 2030 Base Network
    + Scen 4000 - 2045 Base Network
3. Global Model Cycles
    + Default: 4
4. Demographics File
    + households
    + population
    + employment
5. Geographics File
    + parking
    + car share
    + rail station availability
6. Trip Distribution Model
    + Max Iterations Default: 60
    + Max Relative Difference Default: 0.0001
7. Assignment Convergence Criteria
    + Max Iterations Default: 200
8. Toggles for Congested/Capacitated Transit Assignment
    + Default: Enable Congested Transit Assignment
    + Default: Enable Capacited Transit Assignment
9. Number of Processors Specification
    + Default: number of CPUs in computer being used

### 01_CreateScenarios.py
Creates AM, MD and PM network scenarios from the main base year scenario. For example, if the user chose scenario 1000,
this script will create AM, MD and PM scenarios - typically scenarios 21000, 22000 and 23000 - with the relevant network attributes (e.g. bus priority
lanes and headways) by time of day.


### 02_DataImport.py
Imports/generates data used in a model run such as:

1. Values of Time
2. Transit perception Factors
3. External Demand and Trip Distribution K-Factors
4. Starter Skims

### 03_DataGeneration.py
Calculates attributes used in a model run such as:

1. Population and employment densities
2. Accessibility variables (e.g. number of jobs accessible from a zone within 30 minutes)

### 04_SocioEconomicSegmentation.py and 05_VehicleAvailability.py
These two scripts split household data provided by Metro-Vancouver into segments by household size x number of workers x Income Category x Auto Ownership using a series of econometric logit models.

### 06_TripProductions.py and 07_TripAttractions.py
This is the trip generation phase of the model. It includes multiplying econometrically estimated, purpose-specific, production/attraction trip rates by houselhold/population and employment segments (depending on the trip purpose).

### 08_Blended_Skims
Takes AM, MD and PM auto and transit skims and blends them by trip purpose to create 'daily' skims to be used in the trip distribution and mode choice models

### 09-01_HbWork.py - 09-09_NhbOther.py
This series of nine scripts include the trip distribution, mode choice and time of day factoring models for each of the the nine trip purposes.

### 09-00_ModeChoiceUtilities.py
Contains various helper functions that get used repeatedly in the trip distribution/mode choice models such as:

1. Trip distribution gravity model
2. Mode availability conditions

### 09-10_TruckModel.py
Runs the truck model and generates six origin - destination tables - 2 truck types (light and heavy) x 3 time periods

### 10-01_AutoAssignment.py
Runs the auto vehicle traffic assignment for the three time periods

### 10-02_TransitAssignment.py
Runs the transit assignment (bus, rail and WCE) for the three time periods

Other scripts that are included in the Phase3Scripts but not part of a model run:

### 12_DataExport.py
Main model outputs are stored in database format inside the project folder. This tool exports this data to .csv format inside the Outputs folder. The outputs include:

1. Gy - Gy trip summaries by purpose, mode and time period (AM, MD, PM and Daily). One important thing to note is the Daily trip
 summaries are in production - attracion (P-A) format whereas the time of day results are in origin - destination (O-D) format.
2. Network-level summaries: Vehicle volumes by vehicle class, transit volumes, travel time, distance and speed on each link

### ImportNetwork.py and ExportNetwork.py
These two tools allow the import/export of current/future networks after they've been modified. More details will
be provided in the following section using examples.

## Notes on the Use of Numpy and Pandas Python Libraries
Previous versions of the RTM relied largely on INRO's built in matrix calculator method throughout the full model run. In RTM3, most of these calculations are undertaken
instead using Python's built in Numpy and Pandas Libraries. The latest versions of the EMME software allows easy exchange of data between numpy and the Emmebank. For example,
if the number of households per zone is stored in Matrix 'mo1'(or 'md1'), the data can be stored in a vectorized Numpy array object of size 1741x1 (number of TAZs in the model) using the
command: X = emmebank.matrix("mo1").get_numpy_data(), where X is the array object. Once a calculation is completed, the result can be directly stored back into the Emmebank using
the command: emmebank.matrix("mo2").set_numpy_data(X).

Similar operation can be undertaken on full matrices except the array object would be of size 1741x1741.


The example below demonstrates a mode choice utility expression constructed using the matrix calculator and Numpy.

Matrix Calculator:

```
Utility_Transit = str(Bias) + "+" + str(Time_Coeff) + "*mf100"  + "+" + str(Cost_Coeff) + "*mf101" , where mf100 and mf101 are time and cost coefficients.
```

Numpy:

```
Time =  emmebank.matrix("mf100").get_numpy_data()
Cost =  emmebank.matrix("mf101").get_numpy_data()

Utility_Transit = Bias + Time_Coeff * Time + Cost_Coeff * Cost
```

Below are a few advantages of using Numpy:

1) Code is succint and easier to read since it does not require string concatenation
2) Reduces the amount of coding errors
3) Numpy is flexible and significantly faster than Matrix Calculator. This is specially important for complex models with many TAZs
4) Direct integration with Python's Pandas library which allows relational database/SQL type operations such as Join and Relate.

Both the 'get' and 'set' Numpy methods are available in the 'Util' toolbox as helper functions. The two examples below show how these are invoked in the RTM:

Get Method: Array = util.get_matrix_numpy(<Arguments>)
Set Method: Array = util.set_matrix_numpy(<Arguments>)

For more information on Python Coding Guidelines, refer to Appendix XX of this User Guide.

# Step by Step Guide for Running the Model

This chapter provides a step by step guide for running three models. Two examples will be used:

1) Run a base year 2011 run
2) Run a future scenario run which includes demographic, auto and transit network changes.

Both examples will start from the point the user receives the model files from TransLink and provides screenshots to help guide the discussion below.

## 2011 Model Run

This sections provides a step by step guide to launching a base year, 2011, model run assuming no changes to model input data.

1) Unzip folder received from TransLink. The folder contents will look as shown in Figure <folder contents>
2) Run the relocate_tools batch script found inside the Scripts folder
3) Run RTM.emp to launch the EMME. The Explorer will look similar to Figure <Explorer> with one dummy scenario (Scenario 1)
4) Launch EMME Modeller and go to 'Translink RTM Phase 3 Model' tool. The model utilities toolbox, 'Translink Utilities' can also be seen at the botton in Figure <toolbox_screenshot>
5) Launch the Initialize Emmebank tool. Enter a name for the title and folder name of the Emmebank you wish to create and click on the Run button (see Figure <InitEMMEbank>).
6) Close Modeller, the Explorer will now point to the newly created Emmebank which will include four scenarios, one for each horizon year, and associated networks as shown in Figure <new_explorer>.
   The newly created Emmebank folder, 2011_Base in this example, will look similar to Figure <new_emmebank_folder>. You'll notice a copy of the Inputs folder that also exists in the
   RTM -> BaseNetworks directory.
7) Launch Modeller and run the 'Run RTM3' tool inside the 'Translink RTM Phase 3 Model' toolbox.
8) Fill out the user inputs as shown in Figure <Run_Model> tool. The user can change the inputs depending on the type of run being undertaken, however since this is a 2011 base year run the inputs
   will look laregely similar to Figure <Run_Model>.
9) Click the Run Button
10) Once a run is completed, run the Data Export tool under the Stage 4 subfolder and check the Export to CSVs toggle  as shown in Figure <dataexport>. The csv outputs
are stored in the 'Outputs' folder inside the Emmebank folder.

Warnings:

1) In the Model horizon years, make sure you only enter 2011, 2030 and 2045 as certain model components such as the truck model, external demand and bike scores were only setup for these years
2) Make sure the number of processors entered is less than or equal to what the machine supports

## 2030 Model Run

This section provides a step by step guide to setting up a horizon year, 2030, model run which includes the following input assumptions:

 - Revised land-use data
 - New tolled facility
 - New Rail Line
 - New Park and Ride lot

Only steps requiring changes to the input data are included in this section. The user can refer to the previous section on how to launch a model run.

1) Revised Land-use data:
 - Generate a demographics file similar in format to the ones located inside the BaseNetworks - > Inputs directory.
 - Since this model is largely driven by household trip rates, make sure all appropriate demographic attributes are updated. For example, if the scenario modelled
   assumes a 20% population increase in Coquitlam, the number of households in that muncipality should also be updated accordingly

2) New Tolled Facility
 - Make a copy of one of the four main scenarios (in this case we assume scenario 3000 is copied to scenario 3001).
 - Code the new tolled facility. Make sure to follow the Network Coding Guidelines described in Chapter XX.
 - Ensure all ramp sections are coded with the correct volume-delay functions and speeds (refer to Network Coding Guidelines described in Chapter XX)
 - Add the appropriate tolls for each time period
 - Make sure turn penalty functions are coded properly for each time period and accounting for any turn restrictions

3) New Rail Line
 - Code the new rail line facility in scenario 3001. Make sure to follow the Network Coding Guidelines described in Chapter XX.
 - As this is a rail line, we strongly reccomend coding it on separate, rail specific, links with pedestrian links connecting it to the main network.
 - Make sure to code AM, MD and PM headways
 - Make sure to allow boardings and alightings at rail station locations

4) New Park and Ride Lot


5) Final Checks before launching the run:

 -  Make sure to add new transit vehicles if required
 -  Make sure the correct seating and total capacities are provided in the transit vehicles table
 -  Make sure to update the Geographics file if needed. For example, in the New Rail Line scenario, the user will need to update
    the rail station dummy with a value of 1 for TAZs containing those stations.

6) Launch the model run following the steps described in the previous section.

